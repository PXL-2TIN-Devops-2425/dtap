pipeline {
    agent any
    stages {
        stage ('cleanup'){
            steps{
                sh '''
                docker stop `docker ps -q` | echo "no running"
                docker image prune -a

                '''
                cleanWs()
            }
        }
        stage('fetch app code') {
            steps {
                sh '''
                    [ -d ~/.ssh ] || mkdir -m 0700 ~/.ssh
                        # mkdir met een check of de folder al bestaat namelijk de [ -d ~/.ssh ], de -m optie van mkdir werkt hetzelfde als chmod
                    [ -e ~/.ssh/known_hosts ] || touch ~/.ssh/known_hosts
                        # failsafe voor als de known_host file niet bestaat -e staat voor exsists, -f voor of het een file is
                    ssh-keygen -F github.com > NULL || ssh-keyscan -t rsa,ECDSA,Ed25519 github.com >> ~/.ssh/known_hosts
                        # truckje om te voorkomen dat er dubbele keys in komen te staan.
                    '''
                git branch: 'main',
                    credentialsId: 'GitHub.com', 
                    url: 'git@github.com:PXL-2TIN-Devops-2425/calculator-app-finished-y.git'
            }
        }
        stage('Install dependencies') {
            steps {
                nodejs(nodeJSInstallationName: 'TINnode-devops') {
                    sh '''
                        npm config ls
                        npm install
                        npm audit fix
                        npm fund
                        npx browserslist@latest
                    '''
                }
                // https://plugins.jenkins.io/nodejs/
            }
        }
        stage('Build artifact') {
            steps {
                // In deze stage bouw je een docker container van de nodeJS applicatie. (Tip: Zorg eerst voor een werkende Dockerfile en test deze lokaal). De container wordt vanuit de pipeline gebuild.
                writeFile encoding: 'utf-8', file: '.dockerignore', text: 
'''
docker-compose.yml
Dockerfile
.dockerignore
.git
.gitignore
NULL
package-lock.json
tests
'''
                writeFile encoding: 'utf-8', file: 'Dockerfile', text: 
'''FROM node:23-slim
FROM node:23-slim
WORKDIR /app

ADD https://github.com/PXL-2TIN-Devops-2425/calculator-app-finished-y.git .

RUN npm install
RUN npm audit fix
RUN npm fund

EXPOSE 3000

CMD ["npm","start"]
'''
                sh '''
                docker build -t akikasumiizumiborstpxl/calculator .
                docker run --hostname=06bd8e9a1cc0 --mac-address=02:42:ac:11:00:02 --env=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin --env=NODE_VERSION=23.3.0 --env=YARN_VERSION=1.22.22 --network=bridge --workdir=/app -p 3000:3000 --restart=no --runtime=runc -d akikasumiizumiborstpxl/calculator:latest'''      
            }
        
        }
        stage('Push artifact') {
            steps {
                //  In deze stage push je de gebouwde container naar dockerhub. Je maakt hier gebruik van een publieke image op het profiel van één van je teamgenoten.
                echo "blub"
            }
        }
        stage('deployment') {
            steps {
                /* In deze stage zorg je ervoor dat de docker container opgestart wordt op poort 3000 en blijft draaien na het uitvoeren van de pipeline.
                    * _Tip 1: Gebruik de container vanuit dockerhub!_
                    * _Tip 2: Denk eraan dat er misschien nog een vorige versie van de applicatie actief is._
                */
                echo "blub"
            }
        }
    }
}
